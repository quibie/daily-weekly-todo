name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Allows manual triggering from GitHub UI
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  actions: read
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Update TOC version
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_NO_V="${VERSION#v}"  # Remove 'v' prefix
        sed -i "s/## Version: .*/## Version: ${VERSION_NO_V}/" DailyWeeklyTodo.toc
        
    - name: Create addon zip
      run: |
        # Create a temporary directory with the addon name
        mkdir -p package/DailyWeeklyTodo
        
        # Copy addon files (exclude .github and other non-addon files)
        cp *.toc *.lua package/DailyWeeklyTodo/
        
        # Copy Libs folder if it exists
        if [ -d "Libs" ]; then
          cp -r Libs package/DailyWeeklyTodo/
        fi
        
        # Create the zip file
        cd package
        zip -r ../DailyWeeklyTodo-${{ steps.get_version.outputs.VERSION }}.zip DailyWeeklyTodo/
        
    - name: Calculate checksums
      run: |
        sha256sum DailyWeeklyTodo-${{ steps.get_version.outputs.VERSION }}.zip > checksums.txt
        
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        # Create release notes
        cat > release_notes.md << EOF
        ## Daily Weekly Todo ${VERSION}
        
        ### Installation
        1. Download \`DailyWeeklyTodo-${VERSION}.zip\`
        2. Extract to your \`World of Warcraft/Interface/AddOns/\` directory
        3. Restart WoW or type \`/reload\`
        
        ### Compatible Addon Managers
        - Curse/Overwolf
        - WowUp
        - Ajour
        
        ### Changes
        See commit history for detailed changes.
        
        ### Checksums
        \`\`\`
        $(cat checksums.txt)
        \`\`\`
        EOF
        
        # Create release using GitHub CLI
        gh release create "${VERSION}" \
          --title "Daily Weekly Todo ${VERSION}" \
          --notes-file release_notes.md \
          "DailyWeeklyTodo-${VERSION}.zip" \
          "checksums.txt"